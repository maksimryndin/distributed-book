<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Erlang/OTP - Distributed systems for busy engineer</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../preface.html">Preface</a></li><li class="chapter-item expanded "><a href="../introduction/overview.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/network.html"><strong aria-hidden="true">1.1.</strong> Network stack</a></li><li class="chapter-item expanded "><a href="../introduction/tap.html"><strong aria-hidden="true">1.2.</strong> Practice: virtual interface</a></li><li class="chapter-item expanded "><a href="../introduction/network-properties.html"><strong aria-hidden="true">1.3.</strong> Unreliable network</a></li><li class="chapter-item expanded "><a href="../introduction/measure-network.html"><strong aria-hidden="true">1.4.</strong> Measuring network</a></li><li class="chapter-item expanded "><a href="../introduction/availability.html"><strong aria-hidden="true">1.5.</strong> Availability</a></li><li class="chapter-item expanded "><a href="../introduction/decentralized.html"><strong aria-hidden="true">1.6.</strong> Distributed vs Decentralized</a></li><li class="chapter-item expanded "><a href="../introduction/taste-distributed.html"><strong aria-hidden="true">1.7.</strong> Taste of distributed</a></li><li class="chapter-item expanded "><a href="../introduction/exercises.html"><strong aria-hidden="true">1.8.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="../established-systems/overview.html"><strong aria-hidden="true">2.</strong> Established systems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../established-systems/erlang.html" class="active"><strong aria-hidden="true">2.1.</strong> Erlang/OTP</a></li></ol></li><li class="chapter-item expanded "><a href="../consistency/overview.html"><strong aria-hidden="true">3.</strong> Consistency</a></li><li class="chapter-item expanded "><a href="../computing/overview.html"><strong aria-hidden="true">4.</strong> Distributed computing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../computing/ml_training.html"><strong aria-hidden="true">4.1.</strong> ML training</a></li></ol></li><li class="chapter-item expanded "><a href="../decentralized/overview.html"><strong aria-hidden="true">5.</strong> Decentralized</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../decentralized/p2p.html"><strong aria-hidden="true">5.1.</strong> p2p networks</a></li><li class="chapter-item expanded "><a href="../decentralized/blockchain.html"><strong aria-hidden="true">5.2.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="../decentralized/smart-contracts.html"><strong aria-hidden="true">5.3.</strong> Smart contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../references.html"><strong aria-hidden="true">6.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Distributed systems for busy engineer</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/maksimryndin/distributed-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="battle-tested-erlangotp"><a class="header" href="#battle-tested-erlangotp">Battle-tested Erlang/OTP</a></h1>
<blockquote>
<p><em>Any sufficiently complicated concurrent program in another language contains an ad hoc informally-specified bug-ridden slow implementation of half of Erlang.</em>
<a href="https://rvirding.blogspot.com/2008/01/virdings-first-rule-of-programming.html">Robert Virding</a>, one of the creators of Erlang</p>
</blockquote>
<p><a href="https://www.erlang.org">Erlang</a> still remains to be a unique fusion of practical engineering and clever architectural vision. Created in 1980s, it still has such a great potential to evolve in a modern web[^klarna]<sup class="footnote-reference"><a href="#my_experience">1</a></sup>.</p>
<p>We won’t dive in the language per se and pragmatic ideas of “let it fail”, <a href="https://adoptingerlang.org/docs/development/supervision_trees/">supervision trees</a>, and fault tolerance. You can read the very concise and full of practical wisdom <a href="https://erlang.org/download/armstrong_thesis_2003.pdf">thesis</a> (highly recommended) of Joe Armstrong, one of the Erlang creators.</p>
<p>Let’s focus more on Erlang distribution capabilities. Erlang is compiled to run in a virtual machine called BEAM<sup class="footnote-reference"><a href="#lumen">2</a></sup>. <a href="https://elixir-lang.org/">Elixir</a> is also a BEAM-runnable language with interoperability with Erlang.</p>
<p>Erlang lightweight processes, while executing application logic, communicate with each other using signals. Most used signal type is a message<sup class="footnote-reference"><a href="#actor">3</a></sup>. Processes are scheduled for execution by BEAM. You can run millions of processes<sup class="footnote-reference"><a href="#erlang_limits">4</a></sup>. OTP is a collection of reusable components (abstractions for concurrent and distributed patterns such as client-server). So Erlang/OTP is a framework allowing you to quickly create complex concurrent and distributed systems.</p>
<p>BEAM (written in C) can be extended with dynamically loaded compiled modules with Native Implemented Functions (<a href="https://www.erlang.org/doc/tutorial/nif.html">NIFs</a>). So you can write this shared module in a language you prefer (supporting C interoperability, of course)<sup class="footnote-reference"><a href="#rustler">5</a></sup>.<br />
Erlang is primarily well suited for a massive IO-bound load so for CPU-bound tasks you should use, for example, above mentioned NIFs<sup class="footnote-reference"><a href="#erlang_io_bound">6</a></sup>.</p>
<p>Every node (Erlang VM) to form a cluster should share the same cookie file with a secret. It is rather a basic “security” with the aim to differentiate two or more clusters.
Every Erlang VM is started with a predefined name and then it’s enough to register the rest <code>n-1</code> nodes on the first node. All nodes sharing the same cookie will propagate connections to each other creating a fully connected mesh network. This default transitive connection propagation can be configured – a node called <em>hidden node</em> without transitive connections can be used to create clusters with less connections<sup class="footnote-reference"><a href="#erlang_distribution">7</a></sup>.</p>
<p>By default, communication between nodes of a cluster is done over TCP.  Separate daemon process (called EPMD - <a href="https://www.erlang.org/doc/man/epmd.html">Erlang Port Mapper Daemon</a>) starts (if not already running) on every host machine with Erlang VMs. EPMD uses DNS to resolve node names to ip addresses and maps node names to ip+port (tcp socket). EPMD serves as a name resolver for nodes on the host machine.</p>
<p><img src="images/erlang.svg" alt="Erlang" /></p>
<p>You can also implement your own procedures for <a href="https://www.erlang.org/doc/apps/erts/alt_disco.html">nodes discovery</a> and discovery under <a href="https://contactchanaka.medium.com/erlang-cluster-peer-discovery-on-kubernetes-aa2ed15663f9">container</a> orchestrator.</p>
<p>Default Erlang distribution with cookies assumes trusted network so you should change default communication mechanism in case of untrusted network<sup class="footnote-reference"><a href="#epmdless">8</a></sup>. Moreover, large number of nodes with fully connected mesh communicating over large and uncontrolled network can be prohibitatively costly. This break point may range from 40 to 140 nodes<sup class="footnote-reference"><a href="#erlang_nodes">9</a></sup> depending on load and amount of global state required to sync over cluster (such as a process namespace or getting <code>now</code> time which requires global lock to provide monotonically increasing time over the cluster). In such cases federated<sup class="footnote-reference"><a href="#federated">10</a></sup> clusters and partitioning of global state in separate groups of nodes inside a cluster is a way to go<sup class="footnote-reference"><a href="#erlang_scale">11</a></sup>.</p>
<p>Erlang is actively modernized and continuosly developed. So it’s a solid foundation for a distributed system.</p>
<p><strong>Erlang lessons to go distributed</strong>:</p>
<ul>
<li>separation of concerns and modularity - you can configure your communication transport, algorithm of node discovery, network topology;</li>
<li>distributed system must be observable (Erlang has excellent tracing and monitoring <a href="https://www.erlang.org/doc/man/observer.html">tools</a> allowing to observe even specific Erlang processes);</li>
<li>communication is asynchronous so no node has to wait any acknowledgement that its message was received by another one;</li>
<li>message passing is location transparent (the code to send message to local Erlang process is the same as for sending to a process on another node in the cluster – at a cost of more RAM and time to <code>memcpy</code> as every message is deeply copied);</li>
<li>maintaining global mutable data (namespace of lightweight processes in case of Erlang) and full connectivity severely limits scalability.</li>
<li>fail-fast - correctness is more important than availability (of course, depends on the startup time). Erlang philosophy denies defensive programming (when you try to recover from all errors). So assertions in the production code are beneficial - they declare negative flow and don’t allow the distributed system (which is designed to be fault tolerant) to behave incorrectly<sup class="footnote-reference"><a href="#tigerbeetle">12</a></sup>.</li>
</ul>
<div class="footnote-definition" id="klarna"><sup class="footnote-definition-label">13</sup>
<p>For example, Swedish fintech Klarna uses Erlang as it’s core platform handling 2 million transactions per day - look at their <a href="https://jobs.lever.co/klarna?team=Engineering">job descriptions</a>.</p>
</div>
<div class="footnote-definition" id="my_experience"><sup class="footnote-definition-label">1</sup>
<p>At one of my work places I almost convinced my CTO to write IO-bound service for proxying media streams and unary requests in Erlang. For two weeks I read everything on Erlang and finally presented a workable version which was deployed to production. It had worked under production for about 3 weeks till the CTO had a look at the code. He was rather afraid of completely non-imperative style of code and inability to scale his Erlang team (consisted of only me). So he gently asked me to rewrite the app in Go. For those brave of you <a href="https://adoptingerlang.org/">Adopting Erlang</a>.</p>
</div>
<div class="footnote-definition" id="lumen"><sup class="footnote-definition-label">2</sup>
<p>Alternative execution environments (including not only VMs) emerge periodically but I haven’t heard about any production-ready. BEAM is really <a href="https://blog.stenmans.org/theBeamBook/">complicated</a> to reinvent. See also <a href="https://github.com/lumen/lumen">Lumen</a>.</p>
</div>
<div class="footnote-definition" id="actor"><sup class="footnote-definition-label">3</sup>
<p>A lot of holy wars around considering Erlang as an actor language. See <a href="https://softwareengineering.stackexchange.com/questions/277464/is-erlang-really-an-actor-model-language">Stack Exchange question</a> and <a href="http://erlang.org/pipermail/erlang-questions/2014-June/079794.html">Robert Virding’s email</a>.</p>
</div>
<div class="footnote-definition" id="erlang_limits"><sup class="footnote-definition-label">4</sup>
<p>See also <a href="http://erlang.org/documentation/doc-5.8.4/doc/efficiency_guide/advanced.html">http://erlang.org/documentation/doc-5.8.4/doc/efficiency_guide/advanced.html</a></p>
</div>
<div class="footnote-definition" id="rustler"><sup class="footnote-definition-label">5</sup>
<p>See <a href="https://github.com/rusterlium/rustler">Rustler</a></p>
</div>
<div class="footnote-definition" id="erlang_io_bound"><sup class="footnote-definition-label">6</sup>
<p><a href="https://news.ycombinator.com/item?id=15558051">Why we used Pony to write Wallaroo</a>, <a href="https://stackoverflow.com/questions/32846615/what-is-the-best-way-of-doing-computationally-intensive-tasks-in-erlang-w-o-scal"></a></p>
</div>
<div class="footnote-definition" id="erlang_distribution"><sup class="footnote-definition-label">7</sup>
<p><a href="https://www.erlang.org/doc/reference_manual/distributed.html">Distributed Erlang</a></p>
</div>
<div class="footnote-definition" id="epmdless"><sup class="footnote-definition-label">8</sup>
<p>See also <a href="https://github.com/tsloughter/epmdless">epmdless</a>, <a href="https://www.erlang.org/doc/apps/ssl/ssl_distribution.html">Using TLS for Erlang Distribution</a></p>
</div>
<div class="footnote-definition" id="federated"><sup class="footnote-definition-label">10</sup>
<p>Federation is a technique to scale software by grouping its parts by feature. For example, you can federate database in separate servers: one for sessions, second for users, third for sales etc. Increased throughput comes with cost of joining data and holding transactions on the application side.</p>
</div>
<div class="footnote-definition" id="erlang_nodes"><sup class="footnote-definition-label">9</sup>
<p><a href="https://arxiv.org/pdf/1704.07234.pdf">Scaling Reliably: Improving the Scalability of the Erlang Distributed Actor Platform</a></p>
</div>
<div class="footnote-definition" id="erlang_scale"><sup class="footnote-definition-label">11</sup>
<p>See <a href="https://arxiv.org/pdf/1704.07234.pdf">Scaling Reliably: Improving the Scalability of the Erlang Distributed Actor Platform</a>, <a href="https://www.infoq.com/presentations/erland-scale-10000-nodes/">Scaling Erlang Cluster to 10,000 Nodes</a>, <a href="https://stackoverflow.com/questions/5044574/how-scalable-is-distributed-erlang">Stackoverflow question</a></p>
</div>
<div class="footnote-definition" id="tigerbeetle"><sup class="footnote-definition-label">12</sup>
<p>See also Joran Dirk Greef <a href="https://www.youtube.com/watch?v=w3WYdYyjek4">TigerStyle! (Or How To Design Safer Systems in Less Time)</a></p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../established-systems/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../consistency/overview.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../established-systems/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../consistency/overview.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
