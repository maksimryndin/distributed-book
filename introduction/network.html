<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Network stack - Distributed systems for busy engineer</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../preface.html">Preface</a></li><li class="chapter-item expanded "><a href="../introduction/overview.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../introduction/network.html" class="active"><strong aria-hidden="true">1.1.</strong> Network stack</a></li><li class="chapter-item expanded "><a href="../introduction/tap.html"><strong aria-hidden="true">1.2.</strong> Practice: virtual interface</a></li><li class="chapter-item expanded "><a href="../introduction/network-properties.html"><strong aria-hidden="true">1.3.</strong> Unreliable network</a></li><li class="chapter-item expanded "><a href="../introduction/measure-network.html"><strong aria-hidden="true">1.4.</strong> Measuring network</a></li><li class="chapter-item expanded "><a href="../introduction/availability.html"><strong aria-hidden="true">1.5.</strong> Availability</a></li><li class="chapter-item expanded "><a href="../introduction/decentralized.html"><strong aria-hidden="true">1.6.</strong> Distributed vs Decentralized</a></li><li class="chapter-item expanded "><a href="../introduction/taste-distributed.html"><strong aria-hidden="true">1.7.</strong> Taste of distributed</a></li><li class="chapter-item expanded "><a href="../introduction/exercises.html"><strong aria-hidden="true">1.8.</strong> Exercises</a></li></ol></li><li class="chapter-item expanded "><a href="../established-systems/overview.html"><strong aria-hidden="true">2.</strong> Established systems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../established-systems/erlang.html"><strong aria-hidden="true">2.1.</strong> Erlang/OTP</a></li></ol></li><li class="chapter-item expanded "><a href="../consensus/overview.html"><strong aria-hidden="true">3.</strong> Consensus</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../consensus/raft.html"><strong aria-hidden="true">3.1.</strong> Raft</a></li><li class="chapter-item expanded "><a href="../consensus/transactions.html"><strong aria-hidden="true">3.2.</strong> Transactions</a></li><li class="chapter-item expanded "><a href="../consensus/viewstamped.html"><strong aria-hidden="true">3.3.</strong> Viewstamped Replication</a></li></ol></li><li class="chapter-item expanded "><a href="../consistency/overview.html"><strong aria-hidden="true">4.</strong> Consistency</a></li><li class="chapter-item expanded "><a href="../computing/overview.html"><strong aria-hidden="true">5.</strong> Distributed computing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../computing/ml_training.html"><strong aria-hidden="true">5.1.</strong> ML training</a></li></ol></li><li class="chapter-item expanded "><a href="../decentralized/overview.html"><strong aria-hidden="true">6.</strong> Decentralized</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../decentralized/p2p.html"><strong aria-hidden="true">6.1.</strong> p2p networks</a></li><li class="chapter-item expanded "><a href="../decentralized/blockchain.html"><strong aria-hidden="true">6.2.</strong> Blockchain</a></li><li class="chapter-item expanded "><a href="../decentralized/smart-contracts.html"><strong aria-hidden="true">6.3.</strong> Smart contracts</a></li></ol></li><li class="chapter-item expanded "><a href="../references.html"><strong aria-hidden="true">7.</strong> References</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Distributed systems for busy engineer</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/maksimryndin/distributed-book" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="network-stack"><a class="header" href="#network-stack">Network stack</a></h1>
<p>Our <a href="./introduction/overview.html">definition</a> of a distributed system mentions a network as a medium for communication. This medium is a very interesting and complex subject per se but here we only review some core concepts relevant to our study.</p>
<p>Physically nodes (or hosts, think, computers) in the network are connected by means of <em>network interface</em> controllers (NIC, also <em>network adapter</em>) - a special hardware<sup class="footnote-reference"><a href="#virtual_interface">1</a></sup> allowing a computer to connect to the network via a cable (Ethernet) or a radio (WiFi)<sup class="footnote-reference"><a href="#packet_switching">2</a></sup>. This physical layer is called a <em>link</em> in TCP/IP stack<sup class="footnote-reference"><a href="#tcpip">3</a></sup>. Nodes at the link layer are identified by Media Access Control Address (MAC) - a unique hardware identifier of every <strong>network interface</strong> of the host<sup class="footnote-reference"><a href="#mac">4</a></sup>.</p>
<p>We can use <code>ifconfig</code> (or more modern <code>ip addr</code> and <code>ip link show</code>) utility to manage network interfaces. We just describe the most common data:</p>
<ul>
<li><code>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;</code> means that the interface supports broadcasting and multicasting, is loaded (<code>UP</code> as opposite to <code>DOWN</code>), is ready to accept connections (<code>RUNNING</code>). Other popular options are <code>LOOPBACK</code> (it is a loopback interface) and <code>PROMISC</code> (interface is in the promiscuous mode when it captures all packets in the network).</li>
<li><code>mtu 1500</code> - Maximum Transmission Unit is 1500 bytes. So IP packet greater than 1500 bytes will be fragmented.</li>
<li><code>ether bc:d0:74:ec:76:17</code> means MAC is <code>bc:d0:74:ec:76:17</code></li>
<li><code>inet 192.168.43.174 netmask 0xffffff00 broadcast 192.168.43.255</code> means IPv4 address 192.168.43.174 with network mask 255.255.255.0 so we can have hosts 192.168.43.1-254, 192.168.43.255 is a broadcast address and 192.168.43.0 is the network itself.</li>
<li><code>inet6 fe80::88f:5ab4:1ad8:eed5 prefixlen 64 secured scopeid 0xe</code> means IPv6 address <code>fe80::88f:5ab4:1ad8:eed5</code></li>
</ul>
<p>So we have a network of nodes (also called LAN - local area network<sup class="footnote-reference"><a href="#LAN">5</a></sup>). How do we <strong>inter</strong>connect <strong>net</strong>works (to get WAN - wide area network) so that we can send a packet with data (called a <strong>datagram</strong>) between two hosts from different networks? Here a <em>routing</em> problem arises. Computers called <em>routers</em><sup class="footnote-reference"><a href="#bridge">6</a></sup> are relaying datagrams from source to destination accross networks borders<sup class="footnote-reference"><a href="#hop">7</a></sup>. But how do we distinguish a host in one network from a host from another network? We need some <em>addressing</em> at an <em>internet layer</em>. IPv4 addressing assigns each host an IP address of the form xx.xx.xx.xx (4 octets of 8 bits each). But with 2^32 unique IP addresses we cannot mark all hosts so IPv6 was developed (128 bits). IPv4 address exaustion was partially mitigated by so called Network Address Translation (NAT) and private IPs<sup class="footnote-reference"><a href="#private_ips">8</a></sup> which results in violation of the end-to-end principle<sup class="footnote-reference"><a href="#end2end">9</a></sup>. Current adoption of IPv6 you can check with <a href="https://www.google.com/intl/en/ipv6/statistics.html">Google data</a>.
Internet layer is independent of the network topology and the physical way of hosts connection.</p>
<p>Within LAN we need to establish a mapping between an IP addresses of hosts and their corresponding hardware addresses (MAC) to send packet from one host to another. Such a mapping is called ARP table (or ARP cache) and is filled at each host with an Address Resolution Protocol (ARP) broadcast messages. In Linux/Unix ARP table can be manipulated with an <code>arp</code> utility. For IPv6 Neighbor Discovery Protocol handles that.</p>
<p>Routing is mapping of IP addresses to interfaces and can be displayed with <code>netstat -rn</code>. You can trace packet path with <code>tracepath</code>.</p>
<p>After we identified a route between to hosts, we can use a <em>transport</em> protocol to, at least, specify <strong>ports</strong> on hosts to connect specific <em>application</em> processes running on hosts involved. Because internet layer is only responsible for routing and for reliability of communication, transport layer’s protocols can also offer some reliability mechanisms like congestion control, preserves data ordering, eliminate packet loss, provides packet deduplication.</p>
<p>So we have a connection between hosts and we can exchange application data over the transport protocol.</p>
<div class="footnote-definition" id="virtual_interface"><sup class="footnote-definition-label">1</sup>
<p>Network interface can also be virtual to allow userspace applications to intercept raw packets (see <a href="https://www.kernel.org/doc/Documentation/networking/tuntap.txt">Universal TUN/TAP device driver</a>). Also the famous loopback interface (127.0.0.1 for IPv4 and ::1 for IPv6) is virtual.</p>
</div>
<div class="footnote-definition" id="packet_switching"><sup class="footnote-definition-label">2</sup>
<p>we consider only <a href="https://en.wikipedia.org/wiki/Packet_switching">packet networks</a> where the same communication channel can be shared between several communication sessions by means of packetizing data. In contrast, in <a href="https://en.wikipedia.org/wiki/Circuit_switching">circuit networks</a> (for example, public switched telephone network, PSTN) the channel capacity is completely used only by a single communication session between two nodes.</p>
</div>
<div class="footnote-definition" id="tcpip"><sup class="footnote-definition-label">3</sup>
<p>Note that common reference to TCP/IP stack (also called <strong>Internet protocol suite</strong>) includes not only Internet Protocol and Transmission Control Protocol (TCP) but also other protocols such as a User Datagram Protocol (UDP) and QUIC at a transport layer and Internet Protocol Security (IPSec) at an internet layer. TCP/IP stack as a practical network stack predates the OSI theoretical model for general networks.
Since the adoption of TCP/IP in ARPANET in 1983 several proprietary implementations of the stack for different operating systems emerged. But the TCP/IP popularity increased when the University of California at Berkley had open sourced its implementation for BSD Unix becoming famous BSD sockets (see <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite">Wikipedia Internet protocol suite</a>). Among alternatives to TCP/IP were <a href="https://en.wikipedia.org/wiki/IPX/SPX">IPX/SPX</a> and <a href="https://en.wikipedia.org/wiki/AppleTalk">AppleTalk</a>.</p>
</div>
<div class="footnote-definition" id="mac"><sup class="footnote-definition-label">4</sup>
<p>Many network interface controllers allow to overwrite its MAC. In this case the MAC should be unique within the network where the NIC lives. Moreover, software defined MACs are used in VM managed by hypervisors such as QEMU and MAC randomization is gaining popularity to avoid mobile device tracking (see <a href="https://en.wikipedia.org/wiki/MAC_address#Usage_in_hosts">Wikipedia MAC address</a>)</p>
</div>
<div class="footnote-definition" id="LAN"><sup class="footnote-definition-label">5</sup>
<p>the main criteria here is that nodes are physically located nearby. See also <a href="https://iximiuz.com/en/posts/computer-networking-101/">Computer Networking Introduction: Ethernet and IP (Heavily Illustrated)</a> by Ivan Velichko</p>
</div>
<div class="footnote-definition" id="bridge"><sup class="footnote-definition-label">6</sup>
<p>Do not confuse with <a href="https://en.wikipedia.org/wiki/Network_bridge">network bridges</a>. Routers allow separate networks to communicate while bridges join networks making them a single network. While routers interconnect networks at the internet layer, a <em>gateway</em> is a more general term - gateways can interconnect PSTN (Public switched telephone network) and VoIP network acting as <a href="https://en.wikipedia.org/wiki/VoIP_gateway">VoIP gateway</a> or even the internet and satellites orbiting Earth acting as <a href="https://en.wikipedia.org/wiki/Gateway_(telecommunications)#Internet-to-orbit_gateway">Internet-to-orbit gateway</a>. A default gateway is the destination of IP packets if the destination IP of the packet doesn’t belong to the network mask.</p>
</div>
<div class="footnote-definition" id="hop"><sup class="footnote-definition-label">7</sup>
<p>When a packet crosses a border of networks it is called a <em>hop</em>. The time-to-live (TTL) in IPv4 (and <em>hop limit</em> in IPv6) prevents infinite cycling of an IP packet between networks as it is decreased by 1 at every router the packet visits.</p>
</div>
<div class="footnote-definition" id="private_ips"><sup class="footnote-definition-label">8</sup>
<p>Private IPs are <a href="https://datatracker.ietf.org/doc/html/rfc1918#section-3">defined</a> to belong to the following subnets: 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16. Number after the slash is the <em>network prefix</em> (<a href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing">CIDR notation</a>) and denotes number of bits which is common for all hosts in the network. So, for example, 192.168.0.0/16 means that the first 16 bits are the same for all hosts and 192.168 in decimal and the rest 16 bits of total 32 bits define the host (2^16 possible addresses in the network). To be correct, the total number of possible addresses should be decreased by two as all binary zeroes hosts denotes the network itself, while all binary ones host is the broadcast address. So when you encounter an ip 192.168.12.134, you already know that this ip is not reachable publicly (from the Internet), it is some internal private host.
For IPv6 private ip address is not desirable because its main goal is to provide globally unique addressing. So for the LAN use a <a href="https://datatracker.ietf.org/doc/html/rfc4193"><em>unique local unicast address</em></a> starts with a prefix <code>fd</code> (8 bits), then 40 bits of global id (choosen randomly by the operator of the network), then 16 bits for a subnet and the rest 64 bits define the host. So with IPv6 local private ips are essentially globally unique if 40 bits of global id indeed are random and this global uniqueness of local addresses allows to merge two networks without reassigning addresses or using NATs. For IPv6 there is no broadcast - there is only a multicast - when packets are received only by hosts which declared an interest in specific packets.</p>
</div>
<div class="footnote-definition" id="end2end"><sup class="footnote-definition-label">9</sup>
<p><a href="https://en.wikipedia.org/wiki/End-to-end_principle">End-to-end principle</a> means that end hosts themselves (and not other parties) participating in the communication are responsible for communication reliability and security. Lower routing layer is <a href="https://en.wikipedia.org/wiki/Connectionless_communication">connectionless</a>, i.e. each packet goes its own route rather than a prearranged one. Interesting fact: the principle was pioneered by <a href="https://en.wikipedia.org/wiki/CYCLADES">CYCLADES</a> - an INRIA network started the same time as the well-known ARPANET.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../introduction/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../introduction/tap.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../introduction/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../introduction/tap.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
